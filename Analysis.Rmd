---
title: "Untitled"
author: "Lux"
date: "2025-05-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = FALSE,   # hide code
  message = FALSE,   # hide package startup messages
  warning = FALSE    # hide warnings
)

```


```{r echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(readxl)
library(tidyr)
library(data.table)
library(openxlsx)
library(tidyverse)
library(lubridate)
library(hms)
library(readxl)
library(xlsx)
library(here)
library(kableExtra)
library(DT)
library(purrr)
library(tidytext)
library(anytime)
library(grid)
library(wordcloud)
library(reshape2)
library(ggraph)
library(widyr)
library(topicmodels)
library(ggthemes)
library(xlsx)
library(knitr)
library(kableExtra)
library(stopwords)
library(igraph)
library(ggraph)

```



```{r echo=FALSE, eval=FALSE}

data_0 <- read_excel("./data.xlsx", sheet = 1, col_names = TRUE)
data_1 <- read_excel("./filtered_with_keywords_22.xlsx", sheet = 1, col_names = TRUE)
data_2 <- read_excel("./filtered_with_keywords_23.xlsx", sheet = 1, col_names = TRUE)
data_3 <- bind_rows(data_1, data_2)
data <- merge(data_0, data_3, by = "URL", all.x = TRUE)
write.xlsx(data, file = "dta.xlsx", row.names = FALSE, col.names = TRUE)

```


```{r ch2, echo=F, eval=T, message=F , warning= FALSE, message=F}
source(here("Text_analysis", "stemmer.R"))
source(here("Text_analysis", "text_analysis.R"))
source(here("Text_analysis", "write_tokens.R"))
```


```{r echo=FALSE, eval=TRUE}
data <- read_excel("./dta.xlsx", sheet = 1, col_names = TRUE)
```

```{r echo=FALSE, eval=TRUE}
names(data)
```

```{r echo=FALSE, eval=TRUE}
summary(data)
```


```{r prepare-data, echo=F, eval=T, message=F , warning= FALSE}


okviri_all <- c(
  "Ekonomski okvir",
  "Politički okvir",
  "Socijalni okvir",
  "Nacionalni/suverenitetni okvir",
  "Moralno/etički okvir",
  "Tehnološko-administrativni okvir",
  "Ostalo"
)

# cols to drop
cols_to_remove <- c(
  "TWEET_COUNT", "LOVE_COUNT", "WOW_COUNT", "HAHA_COUNT", "SAD_COUNT", "ANGRY_COUNT",
  "FAVORITE_COUNT", "RETWEET_COUNT", "VIEW_COUNT", "DISLIKE_COUNT", "COUNT",
  "REPOST_COUNT", "REDDIT_TYPE", "REDDIT_SCORE",
  "TWEET_TYPE", "TWEET_SOURCE_NAME", "TWEET_SOURCE_URL"
)

df <- data %>%
  # 1) parse, extract & factor
  mutate(
    DATE  = as.Date(DATE),
    TIME  = as_hms(TIME),
    HOUR  = hour(TIME),
    MONTH = month(DATE, label = TRUE, abbr = FALSE),
    OKVIR = factor(OKVIR),
    MEDIJ = FROM_SITE
  ) %>%
  # 2) drop unneeded
  select(-all_of(cols_to_remove), -FROM_SITE) %>%
  # 3) add human‐readable frame labels
  mutate(
    okvir_nazivi = factor(
      as.integer(OKVIR),
      levels = seq_along(okviri_all),
      labels = okviri_all
    )
  )



```



### 1) OKVIR × MEDIJ


```{r echo=F, eval=T, message=F , warning= FALSE}

df %>% 
  count(MEDIJ, OKVIR) %>% 
  pivot_wider(names_from = OKVIR, values_from = n, values_fill = 0) 




```

```{r echo=F, eval=T, message=F , warning= FALSE, dpi = 900, fig.height=6, fig.width=8}

df %>%
  count(okvir_nazivi, MEDIJ) %>%
  ggplot(aes(
    x    = okvir_nazivi,
    y    = n,
    fill = MEDIJ
  )) +
    geom_col(
      position = "dodge",
      color    = "black",
      width    = 0.7
    ) +
    scale_fill_grey(
      start = 0.3,
      end   = 0.8,
      name  = "Medij"
    ) +
    labs(
      x     = "Medijski okvir",
      y     = "Broj članaka",
      title = "Članci po okviru i mediju"
    ) +
    theme_minimal() +
    theme(
      axis.text.x        = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank()
    )



```



```{r echo=F, eval=T, message=F , warning= FALSE}
tbl <- table(df$MEDIJ, df$OKVIR)
chisq_res <- chisq.test(tbl)
chisq_res
```

```{r echo=F, eval=F, message=F , warning= FALSE}
# show 20 most frequent words per OKVIR from this object tidy_text_

tidy_text_ %>%
  group_by(MEDIJ, word) %>%
  summarise(n = n(), .groups = 'drop') %>%
  arrange(MEDIJ, desc(n)) %>%
  group_by(MEDIJ) %>%
  slice_head(n = 10) %>%
  ungroup() %>%
  ggplot(aes(x = reorder_within(word, n, MEDIJ), y = n, fill = MEDIJ)) +
  geom_col(show.legend = FALSE) +
  # This helper function cleans up the axis labels created by reorder_within
  scale_x_reordered() + 
  # Use scales = "free" to allow both axes to vary between facets
  facet_wrap(~ MEDIJ, scales = "free") +
  coord_flip() +
  labs(
    # Note: After coord_flip(), the x-axis label applies to the vertical axis
    x = "Word",
    y = "Count",
    title = "Top 10 Words per MEDIJ"
  ) +
  theme_minimal()




```


```{r echo=F, eval=F, message=F , warning= FALSE}
tidy_text_ %>%
  group_by(OKVIR, word) %>%
  summarise(n = n(), .groups = 'drop') %>%
  arrange(OKVIR, desc(n)) %>%
  group_by(OKVIR) %>%
  slice_head(n = 10) %>%
  ungroup() %>%
  ggplot(aes(x = reorder_within(word, n, OKVIR), y = n, fill = OKVIR)) +
  geom_col(show.legend = FALSE) +
  # This helper function cleans up the axis labels created by reorder_within
  scale_x_reordered() + 
  # Use scales = "free" to allow both axes to vary between facets
  facet_wrap(~ OKVIR, scales = "free") +
  coord_flip() +
  labs(
    # Note: After coord_flip(), the x-axis label applies to the vertical axis
    x = "Word",
    y = "Count",
    title = "Top 10 Words per OKVIR"
  ) +
  theme_minimal()
```


### 2) OKVIR x “vrijeme objave” (MONTH)


```{r okvir-vs-hour-summary, eecho=F, eval=T, message=F , warning= FALSE}
df_monthly <- df %>%
  group_by(okvir_nazivi,MONTH) %>%
  summarize(
    n=n(),
    
  ) 





```



```{r}
#   df_monthly <- data.frame(
#     okvir_nazivi = factor(c("Ekonomski okvir", "Ekonomski okvir", …)),
#     MONTH        = factor(c("January","December", …), levels=month.name),
#     n            = c(11,10, …)
#   )


ggplot(df_monthly, aes(x = okvir_nazivi, y = n, fill = MONTH)) +
  geom_col(position = "dodge", color = "black") +
  scale_fill_grey(
    start  = 0.3,
    end    = 0.7,
    name   = "",                         # legend title
    labels = c("Nakon (sijecanj)", "Prije (prosinac)")           # legend item labels
  ) +
  labs(
    x     = "Medijski okvir",
    y     = "Broj članaka",
    title = ""
  ) +
  theme_minimal() +
  theme(
    axis.text.x        = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor   = element_blank()
  )
```






```{r okvir-vs-hour-test, echo=FALSE, eval=F}
# 2c) Kruskal-Wallis test: Is HOUR different across OKVIR categories?
kruskal.test(MONTH ~ OKVIR, data = df)


```


### 3) OKVIR x Izvor




```{r okvir-vs-izvori-summary, echo=F, eval=T, message=F , warning= FALSE}
# 3a) Summary statistics of IZVORI by OKVIR
df %>%
  group_by(OKVIR) %>%
  summarize(
    #calculate mode for IZVORI
    mode_izvori = as.character(names(sort(table(IZVORI), decreasing = TRUE)[1])),
    
  ) 

```

```{r}
df_izvori <- data.frame(
  OKVIR        = factor(1:7),
  mode_izvori  = c("8","4","4","4","1","3","9"),
  stringsAsFactors = FALSE
) %>%
  mutate(
    mode_izvori = as.integer(mode_izvori),
    okvir_nazivi = factor(
      OKVIR,
      levels = 1:7,
      labels = okviri_all
    )
  )


ggplot(df_izvori, aes(x = okvir_nazivi, y = mode_izvori)) +
  geom_col(
    fill  = "grey70",
    color = "black",
    width = 0.7
  ) +
  labs(
    x     = "Medijski okvir",
    y     = "Modalani broj izvora",
    title = "Broj izvora po okviru"
  ) +
  theme_minimal() +
  theme(
    axis.text.x        = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor   = element_blank()
  )
```


```{r okvir-vs-izvori-test , echo=FALSE, eval=TRUE}
# 3c) Kruskal-Wallis: IZVORI ~ OKVIR
kruskal.test(IZVORI ~ OKVIR, data = df)

```


```{r echo=F, eval=F, message=F , warning= FALSE}
tidy_text_ %>%
  group_by(IZVORI, word) %>%
  summarise(n = n(), .groups = 'drop') %>%
  arrange(IZVORI, desc(n)) %>%
  group_by(IZVORI) %>%
  slice_head(n = 10) %>%
  ungroup() %>%
  ggplot(aes(x = reorder_within(word, n, IZVORI), y = n, fill = IZVORI)) +
  geom_col(show.legend = FALSE) +
  # This helper function cleans up the axis labels created by reorder_within
  scale_x_reordered() + 
  # Use scales = "free" to allow both axes to vary between facets
  facet_wrap(~ IZVORI, scales = "free") +
  coord_flip() +
  labs(
    # Note: After coord_flip(), the x-axis label applies to the vertical axis
    x = "Word",
    y = "Count",
    title = "Top 10 Words per IZVORI"
  ) +
  theme_minimal()
```







### 4) OKVIR x Sentiment

```{r okvir-vs-sentiment-summary , echo=FALSE, eval=TRUE}
# 4a) Count of SENTIMENT × OKVIR
df %>%
  count(OKVIR, SENTIMENT) %>%
  pivot_wider(names_from = SENTIMENT, values_from = n, values_fill = 0) 
```




```{r}
df %>%
  # map OKVIR → Croatian frame names
  mutate(okvir_nazivi = factor(
    as.integer(OKVIR),
    levels = seq_along(okviri_all),
    labels = okviri_all
  )) %>%
  # count articles by frame + sentiment
  count(okvir_nazivi, SENTIMENT) %>%
  # plot side‑by‑side bars (one per sentiment) for each frame
  ggplot(aes(
    x    = okvir_nazivi,
    y    = n,
    fill = factor(SENTIMENT)
  )) +
    geom_col(
      position = position_dodge(width = 0.8),
      color    = "black",
      width    = 0.7
    ) +
    scale_fill_grey(
      start  = 0.2,
      end    = 0.8,
      name   = "Sentiment",
      breaks = c("1","2","3"),
      labels = c("Pozitivan","Neutralan","Negativan")
    ) +
    labs(
      x     = "Medijski okvir",
      y     = "Broj članaka",
      title = "Članci po okviru i sentimentu"
    ) +
    theme_minimal() +
    theme(
      axis.text.x        = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank()
    )
```



```{r okvir-vs-sentiment-test , echo=FALSE, eval=TRUE}
# 4c) If SENTIMENT is treated numerically, compare medians by OKVIR:
kruskal.test(SENTIMENT ~ OKVIR, data = df)

```

### 5) OKVIR x Doseg (reach)



```{r okvir-vs-doseg-summary, echo=FALSE, eval=TRUE}
# 5a) Summary stats of DOSEG by OKVIR
df_reach <- df %>%
  group_by(OKVIR) %>%
  summarize(
    n = n(),
    mean_reach = mean(REACH, na.rm = TRUE),
    median_reach = median(REACH, na.rm = TRUE),
    IQR_reach = IQR(REACH, na.rm = TRUE)
  ) 


```



```{r okvir-vs-doseg-plot, fig.width=7, fig.height=4, echo=FALSE, eval=TRUE}
# 5b) Boxplot (plus jitter) of DOSEG by OKVIR
df_reach %>%
  # 1) map numeric OKVIR → your Croatian labels
  mutate(
    okvir_nazivi = factor(
      as.integer(OKVIR),
      levels = seq_along(okviri_all),
      labels = okviri_all
    )
  ) %>%
  # 2) pivot the three reach columns into long form
  pivot_longer(
    cols      = c(mean_reach, median_reach, IQR_reach),
    names_to  = "metric",
    values_to = "value"
  ) %>%
  # 3) plot side‐by‐side bars
  ggplot(aes(
    x    = okvir_nazivi,
    y    = value,
    fill = metric
  )) +
    geom_col(
      position = position_dodge(width = 0.8),
      color    = "black",
      width    = 0.7
    ) +
    scale_fill_grey(
      start  = 0.2,
      end    = 0.8,
      name   = "Metrika dosega",
      labels = c("Prosječni doseg", "Medijan dosega", "IQR dosega")
    ) +
    labs(
      x     = "Medijski okvir",
      y     = "Vrijednost",
      title = "Doseg po okviru i metrikama"
    ) +
    theme_minimal() +
    theme(
      axis.text.x        = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank()
    )
```

```{r okvir-vs-doseg-test,echo=F, eval=T, message=F , warning= FALSE}
# 5c) Kruskal-Wallis test for DOSEG ~ OKVIR
kruskal.test(OKVIR ~ REACH, data = df)
```



```{r echo=F, eval=F, message=F , warning= FALSE}
tidy_text_ %>%
  group_by(DOSEG, word) %>%
  summarise(n = n(), .groups = 'drop') %>%
  arrange(DOSEG, desc(n)) %>%
  group_by(DOSEG) %>%
  slice_head(n = 10) %>%
  ungroup() %>%
  ggplot(aes(x = reorder_within(word, n, DOSEG), y = n, fill = DOSEG)) +
  geom_col(show.legend = FALSE) +
  # This helper function cleans up the axis labels created by reorder_within
  scale_x_reordered() + 
  # Use scales = "free" to allow both axes to vary between facets
  facet_wrap(~ DOSEG, scales = "free") +
  coord_flip() +
  labs(
    # Note: After coord_flip(), the x-axis label applies to the vertical axis
    x = "Word",
    y = "Count",
    title = "Top 10 Words per DOSEG"
  ) +
  theme_minimal()
```




### 6) OKVIR x Komentari (comments)

```{r okvir-vs-komentari-summary,echo=FALSE, eval=TRUE}
# 6a) Summary stats of KOMENTARI by OKVIR
df_komentari <- df %>%
  group_by(OKVIR) %>%
  summarize(
    n = n(),
    mean_comments = mean(COMMENT_COUNT, na.rm = TRUE),
    median_comments = median(COMMENT_COUNT, na.rm = TRUE),
    IQR_comments = IQR(COMMENT_COUNT, na.rm = TRUE)
  ) 

```




```{r okvir-vs-komentari-plot, fig.width=7, fig.height=4,echo=FALSE, eval=TRUE}
df_komentari %>%
  # map OKVIR → human‐readable labels
  mutate(
    okvir_nazivi = factor(
      as.integer(OKVIR),
      levels = seq_along(okviri_all),
      labels = okviri_all
    )
  ) %>%
  # pivot the three comment metrics into long form
  pivot_longer(
    cols      = c(mean_comments, median_comments, IQR_comments),
    names_to  = "metric",
    values_to = "value"
  ) %>%
  # plot side‑by‑side bars for each metric
  ggplot(aes(
    x    = okvir_nazivi,
    y    = value,
    fill = metric
  )) +
    geom_col(
      position = position_dodge(width = 0.8),
      color    = "black",
      width    = 0.7
    ) +
    scale_fill_grey(
      start  = 0.2,
      end    = 0.8,
      name   = "Metrika komentara",
      labels = c(
        "Prosjecan broj komentara",
        "Medijan komentara",
        "IQR komentara"
      )
    ) +
    labs(
      x     = "Medijski okvir",
      y     = "Vrijednost",
      title = "Komentari po okviru i metrikama"
    ) +
    theme_minimal() +
    theme(
      axis.text.x        = element_text(angle = 45, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor   = element_blank()
    )
```

```{r okvir-vs-komentari-test,echo=FALSE, eval=TRUE}
# 6c) Kruskal-Wallis test: KOMENTARI ~ OKVIR
kruskal.test(COMMENT_COUNT ~ OKVIR, data = df)

```











##$ Text analysis (TITLE)


```{r echo=F, eval=T, message=F , warning= FALSE}
# # read in lexicons
# CroSentilex_n <- read.delim("C:/Users/Lukas/Dropbox/Mislav@Luka/crosentilex-negatives.txt",
#                                    header = FALSE,
#                                    sep = " ",
#                                    stringsAsFactors = FALSE,
#                                    fileEncoding = "UTF-8")  %>%
#                    rename(word = "V1", sentiment = "V2" ) %>%
#                    mutate(brija = "NEG")
#  
# CroSentilex_p  <- read.delim("C:/Users/Lukas/Dropbox/Mislav@Luka/crosentilex-positives.txt",
#                                    header = FALSE,
#                                    sep = " ",
#                                    stringsAsFactors = FALSE,
#                                    fileEncoding = "UTF-8") %>%
#                     rename(word = "V1", sentiment = "V2" ) %>%
#                     mutate(brija = "POZ")
#  
# Crosentilex_sve <- rbind(setDT(CroSentilex_n), setDT(CroSentilex_p))
# # check lexicon data 
# #head(sample_n(Crosentilex_sve,1000),15)
# 
#  
CroSentilex_Gold  <- read.delim2("C:/Users/Lukas/Dropbox/Mislav@Luka/gs-sentiment-annotations.txt",
                                 header = FALSE,
                                 sep = " ",
                                 stringsAsFactors = FALSE) %>%
                    rename(word = "V1", sentiment = "V2" )
 Encoding(CroSentilex_Gold$word) <- "UTF-8"
 CroSentilex_Gold[1,1] <- "dati"
 CroSentilex_Gold$sentiment <- str_replace(CroSentilex_Gold$sentiment , "-", "1")
 CroSentilex_Gold$sentiment <- str_replace(CroSentilex_Gold$sentiment , "\\+", "2")
 CroSentilex_Gold$sentiment <- as.numeric(unlist(CroSentilex_Gold$sentiment))
# check lexicon data 
#head(sample_n(CroSentilex_Gold,100),15)

 
LilaHR  <- read_excel("C:/Users/Lukas/Dropbox/Mislav@Luka/lilaHR_clean.xlsx", sheet = "Sheet1") %>% select (-"...1")
LilaHR_long <- read_excel("C:/Users/Lukas/Dropbox/Mislav@Luka/lilaHR_clean_long.xlsx", sheet = "Sheet1") %>% select (-"...1") 



# Print the long format data
#print(data_long)

#proba <- read.csv2("C:/Users/Lukas/Dropbox/Mislav@Luka/lilaHRcsv.csv", encoding = "UTF-8")
#df <- separate_rows(LilaHR, HR, sep = ", ") 
# 
# zero_rows_count <- sum(apply(df[-1], 1, function(row) all(row == 0)))
# print(zero_rows_count)
# 
# filtered_df <- df %>% 
#   filter(!apply(.[,-1], 1, function(row) all(row == 0)))
#  
# write.xlsx(filtered_df, "C:/Users/Lukas/Dropbox/Mislav@Luka/lilaHR_.xlsx" )

  
# create stop words
stopwords_cro <- get_stopwords(language = "hr", source = "stopwords-iso")
# check stopwords data
#head(sample_n(stopwords_cro,100),15)
# extend stop words
my_stop_words <- tibble(
  word = c(
    "jedan","mjera", "može", "možete", "mogu", "kad", "sada", "treba", "ima", "osoba",
    "e","prvi", "dva","dvije","drugi",
    "tri","treći","pet","kod",
    "ove","ova",  "ovo","bez", "kod",
    "evo","oko",  "om", "ek",
    "mil","tko","šest", "sedam",
    "osam",   "čim", "zbog",
    "prema", "dok","zato", "koji", 
    "im", "čak","među", "tek",
    "koliko", "tko","kod","poput", 
    "baš", "dakle", "osim", "svih", 
    "svoju", "odnosno", "gdje",
    "kojoj", "ovi", "toga",
     "ubera", "vozača", "hrvatskoj", "usluge", "godine", "više", "taksi", "taxi", "taksija", "taksija", "kaže", "rekao", "19"," aee", "ae","bit.ly", "https", "one", "the"
  ),
  lexicon = "lux"
)

# full set with diacritics
cro_sw_full_d <- tibble(word = c("a","ako","ali","baš","bez","bi","bih","bila","bili","bilo","bio","bismo","bit","biti","bolje","bude","čak","čega","čemu","često","četiri","čime","čini","će","ćemo","ćete","ću","da","dakle","dalje","dan","dana","dana","danas","dio","do","dobro","dok","dosta","dva","dvije","eto","evo","ga","gdje","god","godina","godine","gotovo","grada","i","iako","ići","ih","ili","im","ima","imaju","imali","imam","imao","imati","inače","ipak","isto","iz","iza","između","ja","jako","je","jedan","jedna","jednog","jednom","jednostavno","jednu","jer","joj","još","ju","ka","kad","kada","kaj","kako","kao","kaže","kod","koja","koje","kojeg","kojeg","kojem","koji","kojih","kojim","kojima","kojoj","kojom","koju","koliko","kraju","kroz","li","malo","manje","me","među","međutim","mene","meni","mi","milijuna","mislim","mjesto","mnogo","mogao","mogli","mogu","moj","mora","možda","može","možemo","možete","mu","na","način","nad","naime","nakon","nam","naravno","nas","ne","neće","nego","neka","neke","neki","nekog","nekoliko","neku","nema","nešto","netko","ni","nije","nikad","nisam","nisu","ništa","niti","no","njih","o","od","odmah","odnosno","oko","on","ona","onda","oni","onih","ono","opet","osim","ova","ovaj","ovdje","ove","ovim","ovo","ovog","ovom","ovu","pa","pak","par","po","pod","poput","posto","postoji","pred","preko","prema","pri","prije","protiv","prvi","puno","put","radi","reći","s","sa","sad","sada","sam","samo","sati","se","sebe","si","smo","ste","stoga","strane","su","svaki","sve","svi","svih","svoj","svoje","svoju","što","ta","tada","taj","tako","također","tamo","te","tek","teško","ti","tih","tijekom","time","tko","to","tog","toga","toj","toliko","tom","tome","treba","tu","u","uopće","upravo","uvijek","uz","vam","vas","već","vi","više","vrijeme","vrlo","za","zapravo","zar","zato","zbog","zna","znači"),
                        lexicon = "boras")


stop_corpus <- my_stop_words %>%
  bind_rows(stopwords_cro)


stop_corpus <- stop_corpus %>%
  bind_rows(cro_sw_full_d)

# check stopwords data
#head(sample_n(stop_corpus,100),15)
```

```{r echo=F, eval=T, message=F , warning= FALSE}
# dim before tokenize
#dim(dta)

# tokenize
df %>% 
  unnest_tokens(word, TITLE) -> n_token

# dim after tokenize
#dim(n_token)

# check
# fb_token %>% 
#   select(FROM, word, MENTION_SNIPPET ) %>%
#     sample_n(.,100)

# remove stop words, numbers, single letters
n_token %>% 
  anti_join(stop_corpus, by = "word") %>%
  mutate(word = gsub("\\d+", NA, word)) %>%
  mutate(word = gsub("^[a-zA-Z]$", NA, word)) -> n_tokenTidy
# remove NA
n_tokenTidy %>%
  filter(!is.na(word)) -> n_tokenTidy

# check
# fb_tokenTidy  %>% 
#   select(FROM, word, MENTION_SNIPPET ) %>%
#   sample_n(.,100)

# dim after clean
#dim(n_tokenTidy)

```


## STEMMING

```{r echo=F, eval=T, message=F , warning= FALSE}
# Apply stemming to the "word" column
tidy_text_ <- n_tokenTidy %>%
  mutate(
    stemmed_word = sapply(word, function(w) {
      stemmed = write_tokens(w)  # Apply your write_tokens function
      # Process the result similar to your generalno example
      stemmed = sapply(strsplit(stemmed, "\t"), `[`, 2)  # Extract the second element
      stemmed
    })
  )

# Enframe the results if necessary
tidy_text_ <- tidy_text_ %>%
  rename(original_word = word) %>%
  select(URL, original_word, stemmed_word)
```



```{r}
# list 20 most frequent stemmed words and all the original words in the column next to it, also produce the count

tidy_text_ %>% 
  group_by(stemmed_word) %>%
  summarise(original_words = paste(unique(original_word), collapse = ", "),
            count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 10) %>%
  datatable(., options = list(scrollX = TRUE, scrollY = "500px"))



# tidy_text_ %>%
#   group_by(stemmed_word) %>%
#   summarise(count = n()) %>%
#   arrange(desc(count)) %>%
#   filter(count > 10) %>%
#   datatable(., options = list(scrollX = TRUE, scrollY = "500px"))


```



```{r , fig.width=10, fig.height=15, dpi= 600}
# join tidy_text_ with original data

tidy_text_ <- tidy_text_ %>%
  left_join(df, by = "URL") 


# show 20 most frequent words per okvir_nazivi

tidy_text_ %>% 
  group_by(okvir_nazivi, stemmed_word) %>%
  summarise(original_words = paste(unique(original_word), collapse = ", "),
            count = n()) %>%
  arrange(desc(count)) %>%
  filter(count > 10) %>%
  datatable(., options = list(scrollX = TRUE, scrollY = "500px"))



# show in ggplot2
# pick top 10 words per frame
top_words_per_okvir <- tidy_text_ %>%
  count(okvir_nazivi, stemmed_word, name = "n") %>%
  group_by(okvir_nazivi) %>%
  slice_max(n, n = 15) %>%
  ungroup() %>%
  # reorder within each facet
  mutate(stemmed_word = reorder_within(stemmed_word, n, okvir_nazivi))

ggplot(top_words_per_okvir, aes(x = stemmed_word, y = n)) +
  geom_col(fill = "grey60", color = "black") +
  facet_wrap(~ okvir_nazivi, scales = "free_y", ncol = 2) +
  coord_flip() +
  scale_x_reordered() +
  labs(
    title = "Top 10 Stemmed Words by Medijski okvir",
    x     = "Stemmed word",
    y     = "Count"
  ) +
  theme_minimal() +
  theme(
    strip.text         = element_text(face = "bold"),
    axis.text.y        = element_text(size = 8),
    panel.grid.major.y = element_blank(),
    panel.grid.minor   = element_blank(),
    plot.title         = element_text(hjust = 0.5)
  )
```




```{r echo=F, eval=T, message=F , warning= FALSE}
tidy_text_ %>%
  group_by(stemmed_word) %>%
  summarise(count = n()) %>%
  mutate(percent = round(count / sum(count) * 100,2)) %>% 
  arrange(desc(count)) %>%
  filter(count > 10) %>%
  datatable(., options = list(scrollX = TRUE, scrollY = "500px"))
```
##### Doprinos riječi sentimentu (crosentilex)

```{r echo=F, eval=T, message=F , warning= FALSE}
doprinos_sentimentu <- function(dataset, no = n) {
dataset %>%
  inner_join(CroSentilex_Gold, by = "word") %>% 
  count(word, sentiment,sort = TRUE) %>% 
  group_by(sentiment) %>%
  top_n(no) %>%
  ungroup() %>%
  mutate(sentiment = case_when(sentiment == 0 ~ "NEUTRALNO",
                                 sentiment == 1 ~ "NEGATIVNO",
                                 sentiment == 2 ~ "POZITIVNO")) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  ggtitle( "Sentiment") +
  labs( x = "Riječ", y = "Number of words") +
  facet_wrap(~ sentiment, scales = "free_y") +
  coord_flip() +
  scale_fill_manual(values = c("grey40", "grey50","grey60")) +  # Assuming two sentiment values; adjust as needed
  theme_minimal() + 
  theme(
    panel.background = element_blank(),
    strip.background = element_blank(),
    panel.grid = element_blank()
  ) -> gg_doprinos_sentimentu
  
 gg_doprinos_sentimentu
 
}
doprinos_sentimentu(n_tokenTidy,30)

```


##### Doprinos riječi sentimentu (NRC)

```{r echo=F, eval=T, message=F , warning= FALSE}
NRCpn <- LilaHR_long %>% rename("word" = "rijec") %>%
  filter(Emotion %in% c("Positive","Negative")) %>%
  mutate(Emotion = recode(Emotion,
                          "Positive" = "Pozitivno",
                          "Negative" = "Negativno"))


## Sentiment 
doprinos_sentimentu <- function(dataset, no = n) {
dataset %>%
  inner_join(NRCpn, by = "word") %>% 
  count(word, Emotion,sort = TRUE) %>% 
  group_by(Emotion) %>%
  top_n(no) %>%
  ungroup() %>%
#  mutate(sentiment = case_when(sentiment == 0 ~ "NEUTRAL",
#                                 sentiment == 1 ~ "NEGATIVE",
#                                 sentiment == 2 ~ "POSITIVE")) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = Emotion)) +
  geom_col(show.legend = FALSE) +
  ggtitle( "Sentiment") +
  labs( x = "Riječ", y = "Broj riječi") +
  facet_wrap(~ Emotion, scales = "free_y") +
  coord_flip() +
  scale_fill_manual(values = c("grey40", "grey50")) +  # Assuming two sentiment values; adjust as needed
  theme_minimal() + 
  theme(
    panel.background = element_blank(),
    strip.background = element_blank(),
    panel.grid = element_blank()
  ) -> gg_doprinos_sentimentu
  
 gg_doprinos_sentimentu
 
}




doprinos_sentimentu(n_tokenTidy,30)

```
##### Doprinos riječi raznom sentimentu (NRC)
```{r echo=F, eval=T, message=F , warning= FALSE, fig.width=16, fig.height=25}


NRC <- LilaHR_long %>% rename("word" = "rijec") %>%
  filter(Emotion %in% c("Anger","Anticipation","Disgust","Fear","Joy","Sadness","Surprise","Trust")) %>%
  mutate(Emotion = recode(Emotion,
                          "Anger" = "Ljutnja",
                          "Anticipation" = "Iščekivanje",
                          "Disgust" = "Gađenje",
                          "Fear" = "Strah",
                          "Joy" = "Zadovoljstvo",
                          "Sadness" = "Tuga",
                          "Surprise" = "Iznenađenje",
                          "Trust" = "Povjerenje"))


## Sentiment 
doprinos_sentimentu_full <- function(dataset, no = n) {
dataset %>%
  inner_join(NRC, by = "word") %>% 
  count(word, Emotion,sort = TRUE) %>% 
  group_by(Emotion,) %>%
  top_n(no) %>%
  ungroup() %>%
#  mutate(sentiment = case_when(sentiment == 0 ~ "NEUTRAL",
#                                 sentiment == 1 ~ "NEGATIVE",
#                                 sentiment == 2 ~ "POSITIVE")) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n, fill = Emotion)) +
  geom_col(show.legend = FALSE) +
  ggtitle( "Sentiment") +
  labs( x = "Riječ", y = "Broj riječi") +
  facet_wrap(~ Emotion, scales = "free_y") +
  coord_flip() +
  scale_fill_manual(values = c("grey10", "grey20","grey30","grey40","grey50","grey60","grey70","grey80")) +  # Assuming two sentiment values; adjust as needed
  theme_minimal() + 
  theme(
    panel.background = element_blank(),
    strip.background = element_blank(),
    panel.grid = element_blank()
  ) -> gg_doprinos_sentimentu
  
 gg_doprinos_sentimentu
 
}
doprinos_sentimentu_full(n_tokenTidy,20)
```



#### Najčešće fraze (bigrami; moguće i za 3 ili više riječi)(txt)

```{r eval = T, echo = F, message=F, warning=F, fig.height=15, fig.width=15}
fb_bigram <- df %>%
  unnest_tokens(bigram, TITLE, token = "ngrams", n = 2)
#fb_bigram %>% head(10)
# fb_bigram %>%
#   count(bigram, sort = T) %>%
#   head(25) 
fb_bigram_sep <- fb_bigram %>%
  separate(bigram, c("word1","word2"), sep = " ")
fb_bigram_tidy <- fb_bigram_sep %>%
  filter(!word1 %in% stop_corpus$word) %>%
  filter(!word2 %in% stop_corpus$word) %>%
  mutate(word1 = gsub("\\d+", NA, word1)) %>%
  mutate(word2 = gsub("\\d+", NA, word2)) %>%
  mutate(word1 = gsub("^[a-zA-Z]$", NA, word1)) %>%
  mutate(word2 = gsub("^[a-zA-Z]$", NA, word2)) 
fb_bigram_tidy_bigram_counts <- fb_bigram_tidy %>% 
  count(word1, word2, sort = TRUE)

bigrams_united <- fb_bigram_tidy %>%
  unite(bigram, word1, word2, sep = " ") %>%
  filter(., !grepl("NA",bigram))
#bigrams_united
#bigrams_united %>% 
#  count(FROM,bigram,sort = T) -> topicBigram

bigrams_united %>%
  count(bigram, sort = T) %>%
  filter(n>1) %>%
  datatable(., options = list(scrollX = TRUE, scrollY = "500px"))
```


